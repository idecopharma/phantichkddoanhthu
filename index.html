<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BẢNG PHÂN TÍCH KPI KINH DOANH</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-red: #d32f2f;
            --dark-red: #b71c1c;
            --primary-green: #2e7d32;
            --light-bg: #f4f6f8;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --text-dark: #263238;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            padding-bottom: 50px;
        }

        /* HEADER */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(183, 28, 28, 0.3);
        }
        
        .header-title {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .real-time-badge {
            background-color: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background-color: #00e676;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 8px #00e676;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* CARDS */
        .custom-card {
            background: white;
            border-radius: 12px;
            border: none;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s;
            height: 100%;
        }
        
        .custom-card:hover {
            transform: translateY(-2px);
        }

        .card-header-custom {
            background-color: white;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: 600;
            color: var(--text-dark);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* STATS WIDGETS */
        .stat-widget {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 12px;
            background: white;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .stat-widget::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .stat-widget.primary::before { background-color: #1976d2; }
        .stat-widget.success::before { background-color: var(--primary-green); }
        .stat-widget.danger::before { background-color: var(--primary-red); }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .bg-light-blue { background-color: #e3f2fd; color: #1976d2; }
        .bg-light-green { background-color: #e8f5e9; color: var(--primary-green); }
        .bg-light-red { background-color: #ffebee; color: var(--primary-red); }

        .stat-content h3 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .stat-content p { margin: 0; color: #78909c; font-size: 0.9rem; }

        /* UPLOAD AREA */
        .upload-zone {
            border: 2px dashed #cfd8dc;
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .upload-zone:hover {
            border-color: var(--primary-red);
            background: #fff;
        }

        /* TABLE */
        .table-custom thead th {
            background-color: #37474f;
            color: white;
            font-weight: 500;
            border: none;
            padding: 12px 15px;
        }
        
        .table-custom tbody td {
            vertical-align: middle;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .growth-pos { color: var(--primary-green); font-weight: 700; }
        .growth-neg { color: var(--primary-red); font-weight: 700; }

        /* FILTERS & BADGES */
        .filter-btn-group .btn {
            border-radius: 20px;
            padding: 6px 20px;
            margin-right: 5px;
            border: 1px solid #ddd;
            color: #555;
            font-weight: 500;
        }

        .filter-btn-group .btn.active {
            background-color: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        .customer-tag {
            background-color: #eceff1;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin: 2px;
            display: inline-block;
        }
        .customer-tag .close {
            margin-left: 6px;
            cursor: pointer;
            color: var(--primary-red);
            font-weight: bold;
        }

        /* Sync Status fixed top right */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 15px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 0.8rem;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>

    <div class="sync-status">
        <i class="fas fa-wifi me-2" id="conn-icon"></i>
        <span id="connection-text">Đang kết nối...</span>
    </div>

    <div class="dashboard-header">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="header-title"><i class="fas fa-chart-line me-2"></i>Bảng Phân Tích KPI Kinh Doanh</h2>
                    <div class="mt-2">
                        <span class="real-time-badge">
                            <div class="pulse-dot"></div> Hệ thống đồng bộ Real-Time
                        </span>
                    </div>
                </div>
                <div>
                    <button class="btn btn-light text-danger btn-sm fw-bold shadow-sm" onclick="resetAllData()">
                        <i class="fas fa-trash-alt me-1"></i> XÓA DỮ LIỆU
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid px-4">
        
        <div class="row mb-4" id="kpi-summary-area" style="display: none;">
            <div class="col-md-3">
                <div class="stat-widget primary">
                    <div class="stat-content">
                        <p>Doanh Thu Kỳ Này</p>
                        <h3 id="sum-current">0 ₫</h3>
                        <small class="text-muted" id="count-current">0 đơn hàng</small>
                    </div>
                    <div class="stat-icon bg-light-blue">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-widget primary">
                    <div class="stat-content">
                        <p>Doanh Thu Kỳ Trước</p>
                        <h3 id="sum-previous">0 ₫</h3>
                        <small class="text-muted" id="count-previous">0 đơn hàng</small>
                    </div>
                    <div class="stat-icon bg-light-blue">
                        <i class="fas fa-history"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-widget success" id="growth-widget">
                    <div class="stat-content">
                        <p>Tăng Trưởng</p>
                        <h3 id="sum-growth">0%</h3>
                        <small class="text-muted">So với kỳ trước</small>
                    </div>
                    <div class="stat-icon bg-light-green" id="growth-icon-bg">
                        <i class="fas fa-chart-line" id="growth-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-widget primary">
                    <div class="stat-content">
                        <p>Nhân Sự</p>
                        <h3 id="sum-emp">0</h3>
                        <small class="text-muted">Nhân viên hoạt động</small>
                    </div>
                    <div class="stat-icon bg-light-blue">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="custom-card mb-4">
                    <div class="card-header-custom">
                        <span><i class="fas fa-file-upload me-2 text-danger"></i>Nhập Dữ Liệu</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary small">KỲ NÀY</label>
                            <div class="upload-zone" id="upload-current" onclick="document.getElementById('file-current').click()">
                                <i class="fas fa-cloud-upload-alt fa-2x text-secondary mb-2"></i>
                                <div id="current-status-text" class="text-muted small">Chọn file Excel</div>
                            </div>
                            <input type="file" id="file-current" hidden accept=".xlsx, .xls">
                        </div>
                        
                        <div>
                            <label class="form-label fw-bold text-secondary small">KỲ TRƯỚC</label>
                            <div class="upload-zone" id="upload-previous" onclick="document.getElementById('file-previous').click()">
                                <i class="fas fa-history fa-2x text-secondary mb-2"></i>
                                <div id="previous-status-text" class="text-muted small">Chọn file Excel</div>
                            </div>
                            <input type="file" id="file-previous" hidden accept=".xlsx, .xls">
                        </div>
                    </div>
                </div>

                <div class="custom-card">
                    <div class="card-header-custom">
                        <span><i class="fas fa-filter me-2 text-danger"></i>Bộ Lọc & Tùy Chọn</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label small text-muted fw-bold">LOẠI HÀNG HÓA</label>
                            <div class="filter-btn-group d-flex">
                                <button class="btn btn-outline-secondary active filter-btn flex-fill" data-type="all" onclick="setFilter('all')">Tất cả</button>
                                <button class="btn btn-outline-secondary filter-btn flex-fill" data-type="drug" onclick="setFilter('drug')">Thuốc</button>
                                <button class="btn btn-outline-secondary filter-btn flex-fill" data-type="nondrug" onclick="setFilter('nondrug')">Không Thuốc</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small text-muted fw-bold">LOẠI TRỪ KHÁCH HÀNG</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="cust-search" class="form-control" placeholder="Tìm tên khách hàng...">
                                <button class="btn btn-outline-secondary" onclick="clearExcludedCustomers()"><i class="fas fa-times"></i></button>
                            </div>
                            <div id="cust-suggestions" class="list-group position-absolute shadow w-100" style="z-index: 100; max-height: 200px; overflow-y: auto; display:none;"></div>
                            
                            <div id="excluded-list" class="mt-2 border rounded p-2 bg-light" style="min-height: 40px;">
                                <small class="text-muted fst-italic">Chưa có khách hàng bị loại trừ</small>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button class="btn btn-success fw-bold" onclick="analyzeKPI()">
                                <i class="fas fa-sync-alt me-2"></i> CẬP NHẬT PHÂN TÍCH
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-table me-2 text-danger"></i>
                            <span>Chi Tiết Tăng Trưởng Theo Nhân Viên</span>
                        </div>
                        <span class="badge bg-secondary" id="filter-display-badge">Tất cả</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-custom table-hover table-striped mb-0" id="kpi-table">
                                <thead>
                                    <tr>
                                        <th>NHÂN VIÊN</th>
                                        <th class="text-end">KỲ NÀY</th>
                                        <th class="text-end">KỲ TRƯỚC</th>
                                        <th class="text-end">CHÊNH LỆCH</th>
                                        <th class="text-center">%</th>
                                    </tr>
                                </thead>
                                <tbody id="kpi-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>
                                            Vui lòng upload file dữ liệu để xem báo cáo
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. CẤU HÌNH FIREBASE (GIỮ NGUYÊN) ===
        const firebaseConfig = {
            apiKey: "AIzaSyC5-yB_TwgaxqjO7VXFQ6L22FyLRyDZ878",
            authDomain: "bevy-3c9da.firebaseapp.com",
            databaseURL: "https://bevy-3c9da-default-rtdb.firebaseio.com",
            projectId: "bevy-3c9da"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // Biến toàn cục
        let currentPeriodData = [];
        let previousPeriodData = [];
        let excludedCustomers = [];
        let currentFilter = 'all'; 

        // === 2. KẾT NỐI & REAL-TIME ===
        const connectedRef = db.ref(".info/connected");
        connectedRef.on("value", (snap) => {
            const icon = document.getElementById('conn-icon');
            const text = document.getElementById('connection-text');
            if (snap.val() === true) {
                icon.className = 'fas fa-wifi me-2 text-success';
                text.innerText = 'Đã kết nối';
                text.classList.add('text-success');
                text.classList.remove('text-danger');
            } else {
                icon.className = 'fas fa-wifi me-2 text-danger';
                text.innerText = 'Mất kết nối';
                text.classList.add('text-danger');
                text.classList.remove('text-success');
            }
        });

        function initListeners() {
            db.ref('kpi_data/current').on('value', (snapshot) => {
                const data = snapshot.val();
                currentPeriodData = data ? JSON.parse(data) : [];
                updateUploadUI('current', currentPeriodData.length);
                analyzeKPI(false);
            });

            db.ref('kpi_data/previous').on('value', (snapshot) => {
                const data = snapshot.val();
                previousPeriodData = data ? JSON.parse(data) : [];
                updateUploadUI('previous', previousPeriodData.length);
                analyzeKPI(false);
            });

            db.ref('kpi_data/excluded_customers').on('value', (snapshot) => {
                excludedCustomers = snapshot.val() || [];
                renderExcludedTags();
                analyzeKPI(false);
            });

            db.ref('kpi_data/filter_mode').on('value', (snapshot) => {
                const mode = snapshot.val();
                if (mode && mode !== currentFilter) {
                    currentFilter = mode;
                    updateFilterButtons();
                    analyzeKPI(false);
                }
            });
        }

        // === 3. XỬ LÝ UPLOAD & UI ===
        function setupFileUpload(inputId, period) {
            document.getElementById(inputId).addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                    db.ref(`kpi_data/${period}`).set(JSON.stringify(jsonData))
                        .catch(err => alert('Lỗi: ' + err.message));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        setupFileUpload('file-current', 'current');
        setupFileUpload('file-previous', 'previous');

        function updateUploadUI(period, count) {
            const statusText = document.getElementById(`${period}-status-text`);
            const zone = document.getElementById(`upload-${period}`);
            
            if (count > 0) {
                statusText.innerHTML = `<span class="text-success fw-bold"><i class="fas fa-check-circle"></i> Đã tải ${count} dòng</span>`;
                zone.style.borderColor = 'var(--primary-green)';
                zone.style.backgroundColor = '#e8f5e9';
            } else {
                statusText.innerText = "Chưa có dữ liệu";
                zone.style.borderColor = '#cfd8dc';
                zone.style.backgroundColor = '#fafafa';
            }
        }

        // === 4. LOGIC PHÂN TÍCH (CORE) ===
        function analyzeKPI(shouldSaveFilter = true) {
            // Update UI badge
            const badge = document.getElementById('filter-display-badge');
            if(currentFilter === 'drug') badge.innerText = "Bộ lọc: Chỉ THUỐC";
            else if(currentFilter === 'nondrug') badge.innerText = "Bộ lọc: KHÔNG THUỐC";
            else badge.innerText = "Bộ lọc: TẤT CẢ";

            if(shouldSaveFilter) db.ref('kpi_data/filter_mode').set(currentFilter);

            if (currentPeriodData.length === 0 && previousPeriodData.length === 0) {
                document.getElementById('kpi-summary-area').style.display = 'none';
                return;
            }

            const isDrug = (row) => {
                const val = row['Thuốc?'];
                return val === true || val === 'TRUE' || val === 'True' || val === 1;
            };

            const filterData = (data) => {
                return data.filter(row => {
                    const custName = row['Khách hàng'] ? row['Khách hàng'].toString().trim() : '';
                    if (excludedCustomers.includes(custName)) return false;

                    if (currentFilter === 'drug') return isDrug(row);
                    if (currentFilter === 'nondrug') return !isDrug(row);
                    return true;
                });
            };

            const filteredCurrent = filterData(currentPeriodData);
            const filteredPrevious = filterData(previousPeriodData);

            // Tính toán
            const stats = {};
            const aggregate = (list, type) => {
                list.forEach(row => {
                    const emp = row['Nhân viên'] || 'Chưa xác định';
                    const money = parseFloat(row['Tổng tiền']) || 0;
                    
                    if (!stats[emp]) stats[emp] = { cRev: 0, cCount: 0, pRev: 0, pCount: 0 };
                    
                    if (type === 'curr') { stats[emp].cRev += money; stats[emp].cCount++; }
                    else { stats[emp].pRev += money; stats[emp].pCount++; }
                });
            };

            aggregate(filteredCurrent, 'curr');
            aggregate(filteredPrevious, 'prev');

            renderTable(stats);
            renderSummary(filteredCurrent, filteredPrevious);
        }

        // === 5. RENDER DỮ LIỆU ===
        function renderTable(stats) {
            const tbody = document.getElementById('kpi-body');
            tbody.innerHTML = '';

            Object.keys(stats).sort().forEach(emp => {
                const s = stats[emp];
                const diff = s.cRev - s.pRev;
                let growth = 0;
                if (s.pRev > 0) growth = (diff / s.pRev) * 100;
                else if (s.cRev > 0) growth = 100;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${emp}</strong></td>
                    <td class="text-end">
                        <div class="fw-bold text-dark">${formatMoney(s.cRev)}</div>
                        <small class="text-muted" style="font-size:0.75rem">${s.cCount} đơn</small>
                    </td>
                    <td class="text-end">
                        <div class="text-secondary">${formatMoney(s.pRev)}</div>
                        <small class="text-muted" style="font-size:0.75rem">${s.pCount} đơn</small>
                    </td>
                    <td class="text-end">
                        <span class="${diff >= 0 ? 'growth-pos' : 'growth-neg'}">${formatMoney(diff)}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge ${growth >= 0 ? 'bg-success' : 'bg-danger'}">
                            ${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSummary(curr, prev) {
            document.getElementById('kpi-summary-area').style.display = 'flex';
            
            const sC = curr.reduce((a, b) => a + (parseFloat(b['Tổng tiền'])||0), 0);
            const sP = prev.reduce((a, b) => a + (parseFloat(b['Tổng tiền'])||0), 0);
            
            document.getElementById('sum-current').innerText = formatMoney(sC);
            document.getElementById('count-current').innerText = `${curr.length} đơn hàng`;
            document.getElementById('sum-previous').innerText = formatMoney(sP);
            document.getElementById('count-previous').innerText = `${prev.length} đơn hàng`;

            let growth = 0;
            if(sP > 0) growth = ((sC - sP)/sP)*100;
            else if(sC > 0) growth = 100;

            const gEl = document.getElementById('sum-growth');
            gEl.innerText = (growth >= 0 ? "+" : "") + growth.toFixed(1) + "%";
            
            // Style Growth Card
            const widget = document.getElementById('growth-widget');
            const iconBg = document.getElementById('growth-icon-bg');
            const icon = document.getElementById('growth-icon');
            
            if (growth >= 0) {
                widget.className = "stat-widget success";
                iconBg.className = "stat-icon bg-light-green";
                icon.className = "fas fa-arrow-trend-up";
            } else {
                widget.className = "stat-widget danger";
                iconBg.className = "stat-icon bg-light-red";
                icon.className = "fas fa-arrow-trend-down";
            }

            const empSet = new Set();
            curr.forEach(r => empSet.add(r['Nhân viên']));
            document.getElementById('sum-emp').innerText = empSet.size;
        }

        // === 6. HELPER FUNCTIONS ===
        function formatMoney(n) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);
        }

        // Search Suggestion Logic
        const searchInput = document.getElementById('cust-search');
        const suggestBox = document.getElementById('cust-suggestions');
        
        searchInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            if (!val) { suggestBox.style.display = 'none'; return; }
            
            const allCust = new Set();
            currentPeriodData.forEach(r => { if(r['Khách hàng']) allCust.add(r['Khách hàng'].toString()) });
            
            const matches = Array.from(allCust).filter(c => c.toLowerCase().includes(val)).slice(0, 10);
            
            if(matches.length > 0) {
                suggestBox.innerHTML = matches.map(c => 
                    `<a href="#" class="list-group-item list-group-item-action" onclick="addExclude('${c}')">${c}</a>`
                ).join('');
                suggestBox.style.display = 'block';
            } else {
                suggestBox.style.display = 'none';
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== searchInput && e.target !== suggestBox) {
                suggestBox.style.display = 'none';
            }
        });

        function addExclude(name) {
            if (!excludedCustomers.includes(name)) {
                excludedCustomers.push(name);
                db.ref('kpi_data/excluded_customers').set(excludedCustomers);
            }
            searchInput.value = '';
            suggestBox.style.display = 'none';
        }

        function renderExcludedTags() {
            const div = document.getElementById('excluded-list');
            if (excludedCustomers.length === 0) {
                div.innerHTML = '<small class="text-muted fst-italic">Chưa có khách hàng bị loại trừ</small>';
                return;
            }
            div.innerHTML = excludedCustomers.map((c, i) => 
                `<span class="customer-tag">${c} <span class="close" onclick="removeExclude(${i})">&times;</span></span>`
            ).join('');
        }

        function removeExclude(index) {
            excludedCustomers.splice(index, 1);
            db.ref('kpi_data/excluded_customers').set(excludedCustomers);
        }

        function clearExcludedCustomers() {
            if(excludedCustomers.length > 0 && confirm("Xóa toàn bộ danh sách loại trừ?")) {
                db.ref('kpi_data/excluded_customers').set([]);
            }
        }

        function setFilter(type) {
            currentFilter = type;
            analyzeKPI(true);
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.type === currentFilter) {
                    btn.classList.add('active');
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-danger'); // Use red for active
                } else {
                    btn.classList.remove('active', 'btn-danger');
                    btn.classList.add('btn-outline-secondary');
                }
            });
        }

        function resetAllData() {
            if(confirm("CẢNH BÁO: Hành động này sẽ xóa dữ liệu trên TẤT CẢ các máy đang kết nối. Tiếp tục?")) {
                db.ref('kpi_data').remove();
                location.reload();
            }
        }

        // Start
        initListeners();
    </script>
</body>
</html>
